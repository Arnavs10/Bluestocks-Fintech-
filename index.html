<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="images/Copy of logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluestock</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/dashboard.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Poppins font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Inline styles for responsive design and page transitions -->
    
    <style>
        @media (max-width: 768px) {
            .navbar {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                left: 0 !important;
                right: 0 !important;
                box-sizing: border-box !important;
            }
            
            body, html {
                overflow-x: hidden !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }
        
        /* Page transition styles */
        .page-loader {
            display: none;
            position: fixed;
            top: 124px; /* Position below navbar */
            left: 0;
            width: 100%;
            height: calc(100% - 124px);
            background-color: #ffffff;
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        
        .page-loader.active {
            display: flex;
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5640ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure consistent navbar appearance during transitions */
        #navbar-container {
            z-index: 1000;
        }
        
        /* Mobile adjustments for loader */
        @media (max-width: 768px) {
            .page-loader {
                top: 57px;
                height: calc(100% - 57px);
            }
        }
    </style>
</head>
<body>
    <!-- Component containers -->
    <div id="navbar-container">
        <!-- Bluestocks: Added SPA navigation links for dashboard and manage IPO -->
        <nav class="spa-nav">
            <a href="#" data-route="dashboard">Dashboard</a>
            <a href="#" data-route="manage-ipo">Manage IPO</a>
        </nav>
    </div>
    <div id="content-container"></div>
    <div id="footer-container"></div>
    
    <!-- Page transition loader -->
    <div class="page-loader">
        <div class="loader-spinner"></div>
    </div>

    <!-- Scripts -->
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Initialize Supabase client -->
    <script>
        const SUPABASE_URL = 'https://pyxqwiqvyivyopusgcey.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eHF3aXF2eWl2eW9wdXNnY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwOTE1NzEsImV4cCI6MjA2MzY2NzU3MX0.vJEoejN1jgHeU5hcvujKMVuWCHkIy7010N76WXg3_1s';
        window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true
            }
        });
        console.log('Supabase client initialized globally at end of body.');
    </script>

    <!-- App Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/router.js"></script>
    <script src="js/manage-ipo.js"></script>

    <!-- Direct mobile menu toggle script for reliable functionality -->
    <script>
        // Global function for mobile menu toggle that will work with dynamically loaded content
        window.toggleMobileMenu = function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('BLUESTOCKS GLOBAL: Toggle mobile menu called');
            
            // Get elements directly
            const mobileMenu = document.querySelector('.mobile-menu');
            const menuToggle = document.querySelector('.menu-toggle');
            const body = document.body;
            
            if (!mobileMenu || !menuToggle) {
                console.error('Mobile menu elements not found');
                return false;
            }
            
            // Check current visibility state
            const isVisible = window.getComputedStyle(mobileMenu).display !== 'none';
            
            if (isVisible) {
                // Hide menu
                mobileMenu.style.display = 'none';
                body.classList.remove('menu-open');
            } else {
                // Show menu with strong styling to ensure visibility
                mobileMenu.style.display = 'block';
                mobileMenu.style.visibility = 'visible';
                mobileMenu.style.opacity = '1';
                mobileMenu.style.height = 'calc(100vh - 80px)';
                mobileMenu.style.top = '80px';
                mobileMenu.style.width = '100%';
                mobileMenu.style.position = 'fixed';
                mobileMenu.style.zIndex = '9999';
                mobileMenu.style.left = '0';
                mobileMenu.style.backgroundColor = 'white';
                mobileMenu.style.padding = '20px';
                mobileMenu.style.boxShadow = '0 5px 10px rgba(0,0,0,0.1)';
                mobileMenu.style.overflowY = 'auto';
                body.classList.add('menu-open');
                
                // Make sure the menu content is visible
                const navContainer = mobileMenu.querySelector('.nav-links-container');
                if (navContainer) {
                    navContainer.style.display = 'block';
                    navContainer.style.width = '100%';
                }
                
                // Force all links to display properly
                const allLinks = mobileMenu.querySelectorAll('a, div');
                allLinks.forEach(el => {
                    el.style.display = 'block';
                    el.style.visibility = 'visible';
                    el.style.opacity = '1';
                });
            }
            
            return false;
        };
        
        // Add event handler once navbar is loaded
        function attachMobileMenuHandlers() {
            const menuToggle = document.querySelector('.menu-toggle');
            if (menuToggle) {
                console.log('BLUESTOCKS GLOBAL: Attaching global handler to toggle button');
                menuToggle.setAttribute('onclick', 'window.toggleMobileMenu(event); return false;');
                
                // Also add event listeners as a backup
                menuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.toggleMobileMenu(e);
                    return false;
                });
            }
        }
        
        // Setup a mutation observer to watch for navbar loading
        const navbarObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (document.querySelector('.menu-toggle')) {
                    attachMobileMenuHandlers();
                    // Once found, we can disconnect the observer
                    navbarObserver.disconnect();
                }
            });
        });
        
        // Start observing navbar container for changes
        const navbarContainer = document.getElementById('navbar-container');
        if (navbarContainer) {
            navbarObserver.observe(navbarContainer, { childList: true, subtree: true });
        }
    </script>
    
    <!-- Component loader script with routing -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show page loader during transitions
            function showLoader() {
                document.querySelector('.page-loader').classList.add('active');
            }
            
            // Hide page loader
            function hideLoader() {
                document.querySelector('.page-loader').classList.remove('active');
            }
            
            // Function to load HTML components
            async function loadComponent(url, containerId, showLoading = false) {
                console.log(`Loading component: ${url} into #${containerId}`);
                if (showLoading && containerId === 'content-container') {
                    showLoader();
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.error(`Failed to fetch component: ${url}`, response.status, response.statusText);
                        throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    }
                    const html = await response.text();

                    const container = document.getElementById(containerId);
                    if (!container) {
                        console.error(`Container #${containerId} not found.`);
                        if (showLoading && containerId === 'content-container') hideLoader();
                        return;
                    }
                    container.innerHTML = html;

                    // Execute scripts within the loaded component
                    const scripts = Array.from(container.querySelectorAll('script'));
                    console.log(`Found ${scripts.length} scripts to execute in ${url}`);

                    for (let i = 0; i < scripts.length; i++) {
                        const script = scripts[i];
                        console.log(`Processing script ${i + 1}/${scripts.length} in ${url}:`, script.src || 'inline script');
                        const newScript = document.createElement('script');
                        script.getAttributeNames().forEach(attr => newScript.setAttribute(attr, script.getAttribute(attr)));

                        if (script.src) {
                            console.log(`Loading external script ${i + 1}/${scripts.length}: ${script.src}`);
                            // For external scripts, we need to wait for them to load and execute
                            // if subsequent scripts depend on them. This creates a Promise.
                            await new Promise((resolve, reject) => {
                                newScript.onload = () => {
                                    console.log(`External script ${script.src} loaded and executed.`);
                                    resolve();
                                };
                                newScript.onerror = () => {
                                    console.error(`Error loading external script ${script.src}`);
                                    reject(new Error(`Failed to load script: ${script.src}`));
                                };
                                document.head.appendChild(newScript);
                            });
                        } else {
                            // For inline scripts, append and they will execute synchronously relative to this loop iteration
                            console.log(`Executing inline script ${i + 1}/${scripts.length} in ${url}`);
                            newScript.type = 'module'; // Ensure module context for top-level await compatibility
                            newScript.textContent = script.textContent;
                            // Appending to body and immediately removing is a common trick, but ensure it works for your use case.
                            // Scripts added this way might not have access to `document.currentScript`.
                            // A safer way for inline scripts if they don't rely on `document.currentScript` is just to append them.
                            container.appendChild(newScript); // Append to the container to maintain context if possible
                        }
                    }

                    if (showLoading && containerId === 'content-container') {
                        hideLoader();
                    }
                    console.log(`Successfully loaded ${url} into #${containerId}`);

                } catch (error) {
                    console.error(`Error loading component ${url}:`, error);
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: red;">
                                <h2>Component Load Error</h2>
                                <p>Failed to load component from ${url}</p>
                                <p>Error: ${error.message}</p>
                                <button onclick="location.reload()" style="padding: 8px 16px; margin-top: 10px;">Reload Page</button>
                            </div>
                        `;
                    }
                    if (showLoading && containerId === 'content-container') {
                        hideLoader();
                    }
                }
            }
            
            // Global handleRouting function that can be called from other scripts
            window.handleRouting = function(forceReload = false) {
                // Don't process routing if we're in the middle of a redirect, unless force reload
                if (!forceReload && window.authState && window.authState.isRedirecting) {
                    console.log('Routing skipped - redirect in progress');
                    return;
                }
                
                // Prefer route from hash (#/dashboard) to support SPA navigation without changing directory
                const rawHash = window.location.hash || '';
                let routeFromHash = rawHash.startsWith('#/') ? rawHash.slice(2) : (rawHash.startsWith('#') ? rawHash.slice(1) : '');
                
                // Fallback to pathname if no hash route
                const path = window.location.pathname.toLowerCase();
                const cleanPath = routeFromHash || path.replace(/^\/+/,'');
                
                // Store current route in session storage to help with page reloads
                sessionStorage.setItem('currentRoute', cleanPath);
                
                // Check if we're on an auth page
                const isAuthPage = cleanPath.startsWith('signin') || cleanPath.startsWith('signup') ||
                                 cleanPath.startsWith('forgot-password') || cleanPath.startsWith('reset-password');
                const isDashboardPage = cleanPath.startsWith('dashboard') || cleanPath.startsWith('admin-dashboard');
                
                // Debug info to help diagnose routing issues
                console.log('Routing - Path:', path, 'Clean path:', cleanPath, 'Auth page:', isAuthPage, 'Dashboard:', isDashboardPage);
                console.log('Auth state:', window.authState ? 
                          `Authenticated: ${window.authState.isAuthenticated}, Admin: ${window.authState.isAdmin}, Redirecting: ${window.authState.isRedirecting}` : 
                          `Legacy Auth: ${window.userAuthenticated}`);
                
                // Get authentication state from the central state management system
                const isAuthenticated = window.authState ? window.authState.isAuthenticated : window.userAuthenticated;
                const isAdmin = window.authState ? window.authState.isAdmin : true; // Default to true for legacy
                
                // Handle navbar and footer visibility
                if (isAuthPage || isDashboardPage) {
                    // Hide navbar and footer for auth pages and dashboard
                    document.getElementById('navbar-container').style.display = 'none';
                    document.getElementById('footer-container').style.display = 'none';
                } else {
                    // Show and load navbar and footer for other pages
                    document.getElementById('navbar-container').style.display = 'block';
                    document.getElementById('footer-container').style.display = 'block';
                    loadComponent('components/navbar.html', 'navbar-container', false);
                    loadComponent('components/footer.html', 'footer-container', false);
                    
                    // Highlight active link in navbar (runs after navbar is loaded)
                    setTimeout(() => {
                        highlightActiveLink(path);
                    }, 100);
                }
                
                // If we're at the root path, redirect to ipo
                if (path === '/' || path === '') {
                    window.history.pushState({}, '', 'ipo');
                    console.log('Loading IPO component from root path');
                    loadComponent('components/ipo/ipo.html', 'content-container', true);
                    
                    // Highlight IPO link after navbar loads
                    setTimeout(() => {
                        const ipoLink = document.querySelector('.ipo-link a');
                        if (ipoLink) ipoLink.classList.add('active');
                    }, 200);
                }
                // Route to specific content based on path - show loader for content changes
                else if (cleanPath === 'ipo-all-upcoming') {
                    console.log('Loading All Upcoming IPOs component');
                    loadComponent('components/ipo/sections/all-upcoming.html', 'content-container', true);
                }
                else if (cleanPath.startsWith('ipo')) {
                    console.log('Loading IPO component from /ipo path');
                    loadComponent('components/ipo/ipo.html', 'content-container', true);
                } else if (cleanPath.startsWith('community')) {
                    loadComponent('components/community/community.html', 'content-container', true);
                } else if (cleanPath.startsWith('products')) {
                    loadComponent('components/products/products.html', 'content-container', true);
                } else if (cleanPath === 'signin') {
                    loadComponent('components/auth/signin.html', 'content-container', true);
                }
                else if (cleanPath === 'signup') {
                    loadComponent('components/auth/signup.html', 'content-container', true);
                }
                else if (cleanPath === 'forgot-password') {
                    loadComponent('components/auth/forgot-password.html', 'content-container', true);
                }
                else if (cleanPath === 'reset-password') {
                    loadComponent('components/auth/reset-password.html', 'content-container', true);
                } else if (cleanPath.startsWith('brokers')) {
                    loadComponent('components/brokers/brokers.html', 'content-container', true);
                } else if (cleanPath.startsWith('live-news')) {
                    loadComponent('components/live-news/live-news.html', 'content-container', true);
                } else if (cleanPath.startsWith('home')) {
                    // Load home page
                    loadComponent('components/home.html', 'content-container', true);
                } else if (cleanPath.startsWith('signin')) {
                    // If already authenticated, redirect to dashboard
                    if (isAuthenticated) {
                        console.log('User already authenticated, redirecting from signin to admin dashboard');
                        if (window.authState) window.authState.isRedirecting = true;
                        window.history.pushState({}, '', 'admin-dashboard');
                        // Call handleRouting again with force flag to avoid redirect loops
                        setTimeout(() => { 
                            if (window.authState) window.authState.isRedirecting = false;
                            window.handleRouting(true);
                        }, 100);
                        return;
                    }
                    
                    // Clear admin dashboard loaded flag when on signin page
                    sessionStorage.removeItem('adminDashboardLoaded');
                    loadComponent('components/auth/signin.html', 'content-container', true);
                } else if (cleanPath.startsWith('signup')) {
                    // If already authenticated, redirect to dashboard
                    if (isAuthenticated) {
                        console.log('User already authenticated, redirecting from signup to admin dashboard');
                        if (window.authState) window.authState.isRedirecting = true;
                        window.history.pushState({}, '', 'admin-dashboard');
                        // Call handleRouting again with force flag to avoid redirect loops
                        setTimeout(() => { 
                            if (window.authState) window.authState.isRedirecting = false;
                            window.handleRouting(true);
                        }, 100);
                        return;
                    }
                    
                    // Clear admin dashboard loaded flag when on signup page
                    sessionStorage.removeItem('adminDashboardLoaded');
                    loadComponent('components/auth/signup.html', 'content-container', true);
                } else if (cleanPath.startsWith('admin-dashboard')) {
                    // For admin-dashboard route - check authentication
                    if (isAuthenticated) {
                        console.log('Loading admin dashboard for authenticated user');
                        // Set a flag to indicate we've loaded the admin dashboard to prevent reloads
                        sessionStorage.setItem('adminDashboardLoaded', 'true');
                        loadComponent('components/dashboard/admin-dashboard.html', 'content-container', true);
                    } else {
                        // Not authenticated, redirect to signin
                        console.log('Not authenticated, redirecting to signin from admin-dashboard');
                        if (window.authState) window.authState.isRedirecting = true;
                        window.history.pushState({}, '', 'signin');
                        // Call handleRouting again with force flag to avoid redirect loops
                        setTimeout(() => { 
                            if (window.authState) window.authState.isRedirecting = false;
                            window.handleRouting(true);
                        }, 100);
                    }
                } else if (cleanPath.startsWith('dashboard')) {
                    // For dashboard route - all authenticated users treated as admins
                    if (isAuthenticated) {
                        // Redirect to admin dashboard instead
                        console.log('Authenticated user on dashboard route, redirecting to admin dashboard');
                        if (window.authState) window.authState.isRedirecting = true;
                        window.history.pushState({}, '', 'admin-dashboard');
                        // Call handleRouting again with force flag to avoid redirect loops
                        setTimeout(() => { 
                            if (window.authState) window.authState.isRedirecting = false;
                            window.handleRouting(true);
                        }, 100);
                    } else {
                        // Not authenticated, redirect to signin
                        console.log('Not authenticated, redirecting to signin from dashboard');
                        if (window.authState) window.authState.isRedirecting = true;
                        window.history.pushState({}, '', 'signin');
                        // Call handleRouting again with force flag to avoid redirect loops
                        setTimeout(() => { 
                            if (window.authState) window.authState.isRedirecting = false;
                            window.handleRouting(true);
                        }, 100);
                    }
                } else {
                    // Default to ipo page for any other path
                    window.history.pushState({}, '', 'ipo');
                    loadComponent('components/ipo/ipo.html', 'content-container', true);
                }
            };
            
            // Function to highlight active link in navbar
            function highlightActiveLink(path) {
                // First, remove active class from all navigation links
                document.querySelectorAll('.ipo-link a, .community-link a, .products-link a, .brokers-link a, .live-news-link-container a').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Extract route without leading slash for more consistent matching
                const cleanPath = path.replace(/^\/+/,'');
                
                // Then add active class to current link based on cleaned path
                if (cleanPath.startsWith('ipo')) {
                    const ipoLink = document.querySelector('.ipo-link a');
                    if (ipoLink) ipoLink.classList.add('active');
                } else if (cleanPath.startsWith('community')) {
                    const communityLink = document.querySelector('.community-link a');
                    if (communityLink) communityLink.classList.add('active');
                } else if (cleanPath.startsWith('products')) {
                    const productsLink = document.querySelector('.products-link a');
                    if (productsLink) productsLink.classList.add('active');
                } else if (cleanPath.startsWith('brokers')) {
                    const brokersLink = document.querySelector('.brokers-link a');
                    if (brokersLink) brokersLink.classList.add('active');
                } else if (cleanPath.startsWith('live-news')) {
                    const newsLink = document.querySelector('.live-news-link-container a');
                    if (newsLink) newsLink.classList.add('active');
                }
                // We don't highlight any link for home since there's no home link
            }
            
            // Initial route handling
            handleRouting();
            
            // Handle navigation without page refresh
            document.addEventListener('click', function(e) {
                // Find the nearest anchor tag
                let target = e.target;
                while (target && target.tagName !== 'A') {
                    target = target.parentNode;
                    if (!target) return;
                }
                
                // Only handle internal links
                const href = target.getAttribute('href');
                if (href && !href.startsWith('http') && !href.startsWith('mailto:') && href !== '#') {
                    e.preventDefault();
                    
                    // Show loader before navigation
                    showLoader();
                    
                    // Update URL without refreshing page
                    window.history.pushState({}, '', href);
                    
                    // Use the global handleRouting function
                    window.handleRouting();
                }
            });
            
            // Handle back/forward browser navigation
            window.addEventListener('popstate', function() {
                window.handleRouting();
            });
        });
    </script>
<script>
// SPA Route Table
const SPA_ROUTES = {
    'dashboard': '/components/dashboard/admin-dashboard.html',
    'manage-ipo': '/components/dashboard/manage-ipo.html'
};

// SPA Navigation Handler
function handleSpaNavigation(route) {
    const url = SPA_ROUTES[route];
    if (url) {
        // Optionally show loader
        const container = document.getElementById('content-container');
        if (container) {
            container.innerHTML = '<div style="padding:2em;text-align:center;">Loading...</div>';
            fetch(url)
                .then(resp => resp.text())
                .then(html => { container.innerHTML = html; })
                .catch(() => { container.innerHTML = '<div style="color:red;">Failed to load page.</div>'; });
        }
    }
}

// Listen for SPA navigation clicks
window.addEventListener('DOMContentLoaded', function() {
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a[data-route]');
        if (link) {
            e.preventDefault();
            const route = link.getAttribute('data-route');
            handleSpaNavigation(route);
        }
    });
});
</script>
</body>
</html>
