<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bluestock Fintech</title>
    <!-- Authentication persistence handler - loads first to prevent redirect issues -->
    <script src="../../js/admin-auth-persistence.js"></script>
    <link rel="stylesheet" href="../../styles/dashboard/admin-dashboard.css">
    <!-- Using Font Awesome 6 for all icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load Supabase JavaScript SDK first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Directly initialize Supabase and check auth state -->
    <script>
        // Fallback initialization ensures Supabase client exists even when this page is loaded directly (e.g. browser hard refresh)
        const SUPABASE_URL = 'https://pyxqwiqvyivyopusgcey.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eHF3aXF2eWl2eW9wdXNnY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwOTE1NzEsImV4cCI6MjA2MzY2NzU3MX0.vJEoejN1jgHeU5hcvujKMVuWCHkIy7010N76WXg3_1s';
        
        // Check for authentication on direct page load (critical for persistence)
        if (window.location.href.includes('admin-dashboard')) {
            // First, set a flag to prevent redirect loops
            sessionStorage.setItem('adminDashboardDirectLoad', 'true');
            sessionStorage.setItem('adminDashboardLoaded', 'true');
            
            // Check for auth token to quickly verify if user might be authenticated
            const hasAuthToken = !!localStorage.getItem('sb-pyxqwiqvyivyopusgcey-auth-token');
            const hasBluestockAuth = localStorage.getItem('bluestock_user_authenticated') === 'true';
            const hasUserEmail = !!localStorage.getItem('bluestock_user_email');
            
            console.log('[Auth Debug] Direct admin dashboard load - Auth indicators:', {
                token: hasAuthToken,
                bluestockAuth: hasBluestockAuth,
                email: hasUserEmail
            });
            
            if (!hasAuthToken && !hasBluestockAuth && !hasUserEmail) {
                console.log('[Auth Debug] No auth indicators found, redirecting to signin');
                window.location.href = '/components/auth/signin.html';
            }
        }
        
        if (!window.supabaseClient && window.supabase) {
            window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true,
                    storageKey: 'sb-pyxqwiqvyivyopusgcey-auth-token'
                }
            });
            console.log('[Bluestocks] Supabase client (fallback) initialised in admin-dashboard.html early');
        }
        
        // User name update - Apply the name as soon as page starts loading
        (function() {
            // Function to update the user name
            function updateUserName() {
                try {
                    // Direct DOM manipulation
                    var nameElement = document.getElementById('userDisplayName');
                    if (!nameElement) {
                        return false;
                    }
                    
                    // 1. First try: Use directly from metadata in window object
                    if (window.userMetadata && window.userMetadata.full_name) {
                        nameElement.innerHTML = 'Hi, ' + window.userMetadata.full_name;
                        return true;
                    }
                    
                    // 2. Second try: Use from localStorage
                    var savedName = localStorage.getItem('bluestock_user_name');
                    if (savedName) {
                        nameElement.innerHTML = 'Hi, ' + savedName;
                        return true;
                    }
                    
                    // 3. Third try: Get directly from Supabase
                    if (window.supabaseClient) {
                        window.supabaseClient.auth.getUser().then(function(response) {
                            if (response && response.data && response.data.user && 
                                response.data.user.user_metadata && 
                                response.data.user.user_metadata.full_name) {
                                
                                nameElement.innerHTML = 'Hi, ' + response.data.user.user_metadata.full_name;
                                
                                // Save for future use
                                localStorage.setItem('bluestock_user_name', response.data.user.user_metadata.full_name);
                            }
                        });
                    }
                    
                    return false; // We couldn't immediately update, but async update might be happening
                } catch (e) {
                    return false;
                }
            }
            
            // Run immediately
            var updated = updateUserName();
            
            // If not updated immediately, set up retries
            if (!updated) {
                var retryAttempts = 0;
                var retryInterval = setInterval(function() {
                    retryAttempts++;
                    
                    if (updateUserName() || retryAttempts > 20) {
                        clearInterval(retryInterval);
                    }
                }, 200); // Try every 200ms
            }
        })();
        
        // Immediately use the global Supabase client
        (function() {
            const supabase = window.supabaseClient;
            if (!supabase) {
                console.error('Supabase client not initialized. Certain authenticated features may not work.');
                return;
            }
            try {
                
                // Check session immediately
                window.supabaseClient.auth.getSession().then(({ data, error }) => {
                    if (!error && data && data.session) {
                        // Store session data globally
                        window.authSession = data.session;
                        
                        // Get user data
                        window.supabaseClient.auth.getUser().then(({ data: userData, error: userError }) => {
                            if (!userError && userData && userData.user) {
                                // Store user data globally
                                window.currentUser = userData.user;
                                // Store user metadata for easy access
                                window.userMetadata = userData.user.user_metadata || {};
                            }
                        });
                    }
                });
            } catch (e) {
                // Silent error handling in production
            }
        })();
    </script>
    <!-- Then load our auth.js which depends on it -->
    <script src="../../js/auth.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="brand" id="company-brand">
                <div class="company-logo">BF</div>
                <span>Bluestock Fintech</span>
            </div>
            
            <div class="menu-header">MENU</div>
            <nav class="menu">
                <a href="#" data-route="dashboard" class="active"><i class="fa-solid fa-table-cells-large"></i> Dashboard</a>
                <a href="#" data-route="manage-ipo"><i class="fa-solid fa-list-check"></i> Manage IPO</a>
                <a href="#"><i class="fa-solid fa-file-invoice"></i> IPO Subscription</a>
                <a href="#"><i class="fa-solid fa-chart-pie"></i> IPO Allotment</a>
            </nav>
            
            <div class="menu-header">OTHERS</div>
            <nav class="menu">
                <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
                <a href="#"><i class="fa-solid fa-plug"></i> API Manager</a>
                <a href="#"><i class="fa-solid fa-users"></i> Accounts</a>
                <a href="#"><i class="fa-solid fa-circle-question"></i> Help</a>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Search and User Info -->
            <div class="header">
                <div class="search-bar">
                    <input type="text" placeholder="Search" class="search-input">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                </div>
                <div class="user-info">
                    <div class="user">
                        <div class="user-avatar">
                            <div class="avatar-circle"></div>
                        </div>
                        <div class="user-dropdown-container">
                            <span id="userDisplayName" class="user-dropdown-toggle" tabindex="0">Hi, User</span>
                            <i class="fa-solid fa-chevron-down user-dropdown-toggle" tabindex="0"></i>
                            <div id="userDropdownMenu" class="user-dropdown-menu">
                                <button id="logoutBtn" class="logout-btn">Logout</button>
                            </div>
                        </div>
                        <!-- Direct name update script -->
                        <script>
                            // Immediate execution to update name right where it appears in the DOM
                            (function() {
                                try {
                                    // Wait just a moment for the Supabase init to complete
                                    setTimeout(function() {
                                        // Direct access to the element we just defined above
                                        var userNameEl = document.getElementById('userDisplayName');
                                        
                                        // Method 1: Use the metadata we just stored in the head section
                                        if (window.userMetadata && window.userMetadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.userMetadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 2: Try to get from currentUser
                                        if (window.currentUser && window.currentUser.user_metadata && 
                                            window.currentUser.user_metadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.currentUser.user_metadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 3: Direct Supabase query
                                        if (window.supabaseClient) {
                                            window.supabaseClient.auth.getUser().then(function(result) {
                                                if (result && result.data && result.data.user && 
                                                    result.data.user.user_metadata && 
                                                    result.data.user.user_metadata.full_name) {
                                                    userNameEl.textContent = 'Hi, ' + result.data.user.user_metadata.full_name;
                                                }
                                            });
                                        }
                                    }, 200); // Small delay to ensure the element is fully rendered
                                } catch(e) {
                                    // Silent error handling in production
                                }
                            })();
                        </script>
                    </div>
                    <div class="notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Title and Social Icons -->
            
            <!-- Dashboard Title -->
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h1>Dashboard</h1>
                </div>
            </div>
            
            
            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- IPO Dashboard India Section -->
                <div class="widget ipo-dashboard">
                    <h2>IPO Dashboard India</h2>
                    
                    <div class="ipo-stats">
                        <p class="stat-item"><span class="arrow-up">↑</span> 20 IPO in Gain</p>
                    </div>
                    
                    <div class="ipo-image-charts">
                        <div class="ipo-image-chart-item chart-loss">
                            <img src="../../images/icons/chart-1.png" alt="IPO in Loss Chart">
                        </div>
                        <div class="ipo-image-chart-item chart-gain">
                            <img src="../../images/icons/chart-2.png" alt="IPO in Gain Chart">
                            <div class="chart-label">
                            </div>
                        </div>
                        <div class="ipo-image-chart-item chart-total">
                            <img src="../../images/icons/chart-3.png" alt="Total IPO Chart">
                            <div class="chart-label">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Links Section -->
                <div class="widget quick-links">
                    <h2>Quick Links</h2>
                    <p>Adipiscing elit, sed do eiusmod tempor</p>
                    
                    <ul class="links-list">
                        <li>
                            <div class="link-icon nse"><img src="../../images/Company LOGO/NSE.png" alt="NSE Logo" /></div>
                            <span>NSE India</span>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon bse"><img src="../../images/Company LOGO/BSE.png" alt="BSE Logo" /></div>
                            <span>BSE India</span>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon sebi"><img src="../../images/Company LOGO/SEBI.png" alt="SEBI Logo" /></div>
                            <span>SEBI</span>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon money-control"><img src="../../images/Company LOGO/moneyControl.png" alt="Money Control Logo" /></div>
                            <span>Money Control</span>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                    </ul>
                </div>
                
                <!-- Main Board IPO -->
                <div class="widget main-board">
                    <div class="board-header">
                        <h2>Main Board IPO</h2>
                        <a href="#" class="view-report">View Report</a>
                    </div>
                    <p class="board-subtitle">From 01 Jan 2024</p>
                    
                    <div class="main-board-image-container">
                        <img src="../../images/icons/rightchart.png" alt="Main Board IPO Chart">
                        <div class="chart-tooltip">
                            <p>Afternoon</p>
                            <p>IPO NSE & BSE</p>
                            <p class="tooltip-value">15</p>
                        </div>
                    </div>
                    <div class="main-board-legend">
                        <div class="legend-item">
                            <span class="legend-dot upcoming"></span>
                            <span class="legend-label">Upcoming</span>
                            <span class="legend-count">15</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot new-listed"></span>
                            <span class="legend-label">New Listed</span>
                            <span class="legend-count">25</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot ongoing"></span>
                            <span class="legend-label">Ongoing</span>
                            <span class="legend-count">2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // User dropdown toggle
            const userDropdownToggles = document.querySelectorAll('.user-dropdown-toggle');
            const userDropdownMenu = document.getElementById('userDropdownMenu');
            
            userDropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    userDropdownMenu.classList.toggle('show');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.matches('.user-dropdown-toggle') && !e.target.closest('.user-dropdown-menu')) {
                    if (userDropdownMenu.classList.contains('show')) {
                        userDropdownMenu.classList.remove('show');
                    }
                }
            });
            
            // Dropdown logic for user menu
            const toggles = document.querySelectorAll('.user-dropdown-toggle');
            const dropdown = document.getElementById('userDropdownMenu');
            
            if (toggles && dropdown) {
                toggles.forEach(function(toggle) {
                    toggle.addEventListener('click', function(e) {
                        console.log('Dropdown toggle clicked'); // DEBUG ONLY
                        e.stopPropagation();
                        dropdown.classList.toggle('show');
                    });
                    
                    toggle.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            dropdown.classList.toggle('show');
                        }
                    });
                });
                
                document.addEventListener('click', function() {
                    dropdown.classList.remove('show');
                });
                
                dropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Logout button logic
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    console.log('Logout button clicked');
                    
                    // Close the dropdown menu
                    const dropdown = document.getElementById('userDropdownMenu');
                    if (dropdown) dropdown.classList.remove('show');
            
                    try {
                        // Clear authentication state from localStorage
                        localStorage.removeItem('bluestock_user_authenticated');
                        localStorage.removeItem('bluestock_user_email');
                        localStorage.removeItem('bluestock_user_name');
                        
                        // Clear session flags
                        sessionStorage.removeItem('adminDashboardLoaded');
                        sessionStorage.removeItem('adminDashboardDirectLoad');
                        
                        // Use router logout if available
                        if (window.bluestockRouter && typeof window.bluestockRouter.signOut === 'function') {
                            console.log('Using router signOut method');
                            await window.bluestockRouter.signOut();
                            return; // Router will handle redirection
                        }
                        
                        // Fallback (if router not available):
                        if (window.supabaseClient) {
                            console.log('Using direct Supabase signOut');
                            await window.supabaseClient.auth.signOut();
                        }
                        
                        // Direct redirection to IPO page
                        console.log('Redirecting to IPO page');
                        window.location.href = '/ipo';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        // Ensure redirection even if there's an error
                        window.location.href = '/ipo';
                    }
                });
            }
        });
    </script>
    
    <script src="../../js/router.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Bluestock DEBUG] DOMContentLoaded event fired');
            if (window.bluestockRouter) {
                console.log('[Bluestock DEBUG] Forcing window.bluestockRouter.init()');
                window.bluestockRouter.init();
            } else {
                console.error('[Bluestock DEBUG] window.bluestockRouter is not defined!');
            }
        });
    </script>
</body>
</html>
