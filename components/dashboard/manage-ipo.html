<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage IPO - Bluestock Fintech</title>
    <link rel="stylesheet" href="../../styles/dashboard/admin-dashboard.css">
    <link rel="stylesheet" href="../../styles/dashboard/dropdown.css">
    <link rel="stylesheet" href="../../styles/dashboard/dropdown-reset.css">
    <link rel="stylesheet" href="../../styles/dashboard/manage-ipo.css">
    <!-- Using Font Awesome 6 for all icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load Supabase JavaScript SDK first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load our Supabase initialization -->
    <script src="../../js/supabase-init.js"></script>
    <!-- Load our router -->
    <script src="../../js/router.js"></script>
    <!-- Load auth script -->
    <script src="../../js/auth.js"></script>
    <!-- Directly initialize Supabase and check auth state -->
    <script>
        // User name update - Apply the name as soon as page starts loading
        (function() {
            // Function to update the user name
            function updateUserName() {
                try {
                    // Direct DOM manipulation
                    var nameElement = document.getElementById('userDisplayName');
                    if (!nameElement) {
                        return false;
                    }
                    
                    // 1. First try: Use directly from metadata in window object
                    if (window.userMetadata && window.userMetadata.full_name) {
                        nameElement.innerHTML = 'Hi, ' + window.userMetadata.full_name;
                        return true;
                    }
                    
                    // 2. Second try: Use from localStorage
                    var savedName = localStorage.getItem('bluestock_user_name');
                    if (savedName) {
                        nameElement.innerHTML = 'Hi, ' + savedName;
                        return true;
                    }
                    
                    // 3. Third try: Get directly from Supabase
                    if (window.supabaseClient) {
                        window.supabaseClient.auth.getUser().then(function(response) {
                            if (response && response.data && response.data.user && 
                                response.data.user.user_metadata && 
                                response.data.user.user_metadata.full_name) {
                                
                                nameElement.innerHTML = 'Hi, ' + response.data.user.user_metadata.full_name;
                                
                                // Save for future use
                                localStorage.setItem('bluestock_user_name', response.data.user.user_metadata.full_name);
                            }
                        });
                    }
                    
                    return false; // We couldn't immediately update, but async update might be happening
                } catch (e) {
                    return false;
                }
            }
            
            // Run immediately
            var updated = updateUserName();
            
            // If not updated immediately, set up retries
            if (!updated) {
                var retryAttempts = 0;
                var retryInterval = setInterval(function() {
                    retryAttempts++;
                    
                    if (updateUserName() || retryAttempts > 20) {
                        clearInterval(retryInterval);
                    }
                }, 200); // Try every 200ms
            }
        })();
        
        // Immediately use the global Supabase client
        (function() {
            const supabase = window.supabaseClient;
            if (!supabase) {
                alert('Authentication error: Supabase client not initialized. Please reload the page or contact support.');
                throw new Error('Supabase client not initialized.');
            }
            try {
                
                // Check session immediately
                window.supabaseClient.auth.getSession().then(({ data, error }) => {
                    if (!error && data && data.session) {
                        // Store session data globally
                        window.authSession = data.session;
                        
                        // Get user data
                        window.supabaseClient.auth.getUser().then(({ data: userData, error: userError }) => {
                            if (!userError && userData && userData.user) {
                                // Store user data globally
                                window.currentUser = userData.user;
                                // Store user metadata for easy access
                                window.userMetadata = userData.user.user_metadata || {};
                            }
                        });
                    }
                });
            } catch (e) {
                // Silent error handling in production
            }
        })();
    </script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="brand" id="company-brand">
                <div class="company-logo">BF</div>
                <span>Bluestock Fintech</span>
            </div>
            
            <div class="menu-header">MENU</div>
            <nav class="menu">
                <a href="#" data-route="dashboard"><i class="fa-solid fa-table-cells-large"></i> Dashboard</a>
                <a href="#" data-route="manage-ipo" class="active"><i class="fa-solid fa-list-check"></i> Manage IPO</a>
                <a href="#"><i class="fa-solid fa-file-invoice"></i> IPO Subscription</a>
                <a href="#"><i class="fa-solid fa-chart-pie"></i> IPO Allotment</a>
            </nav>
            
            <div class="menu-header">OTHERS</div>
            <nav class="menu">
                <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
                <a href="#"><i class="fa-solid fa-plug"></i> API Manager</a>
                <a href="#"><i class="fa-solid fa-users"></i> Accounts</a>
                <a href="#"><i class="fa-solid fa-circle-question"></i> Help</a>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Search and User Info -->
            <div class="header">
                <div class="search-bar">
                    <input type="text" placeholder="Search" class="search-input">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                </div>
                <div class="user-info">
                    <div class="user">
                        <div class="user-avatar">
                            <div class="avatar-circle"></div>
                        </div>
                        <div class="user-dropdown-container">
                            <span id="userDisplayName" class="user-dropdown-toggle" tabindex="0">Hi, User</span>
                            <i class="fa-solid fa-chevron-down user-dropdown-toggle" tabindex="0"></i>
                            <div id="userDropdownMenu" class="user-dropdown-menu">
                                <button id="logoutBtn" class="logout-btn">
                                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                        <!-- Direct name update script -->
                        <script>
                            // Immediate execution to update name right where it appears in the DOM
                            (function() {
                                try {
                                    // Wait just a moment for the Supabase init to complete
                                    setTimeout(function() {
                                        // Direct access to the element we just defined above
                                        var userNameEl = document.getElementById('userDisplayName');
                                        
                                        // Method 1: Use the metadata we just stored in the head section
                                        if (window.userMetadata && window.userMetadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.userMetadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 2: Try to get from currentUser
                                        if (window.currentUser && window.currentUser.user_metadata && 
                                            window.currentUser.user_metadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.currentUser.user_metadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 3: Direct Supabase query
                                        if (window.supabaseClient) {
                                            window.supabaseClient.auth.getUser().then(function(result) {
                                                if (result && result.data && result.data.user && 
                                                    result.data.user.user_metadata && 
                                                    result.data.user.user_metadata.full_name) {
                                                    userNameEl.textContent = 'Hi, ' + result.data.user.user_metadata.full_name;
                                                }
                                            });
                                        }
                                    }, 200); // Small delay to ensure the element is fully rendered
                                } catch(e) {
                                    // Silent error handling in production
                                }
                            })();
                        </script>
                    </div>
                    <div class="notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Title and Social Icons -->
            
            <!-- Dashboard Title -->
            <div class="dashboard-header">
                <h1>Upcoming IPO <span class="header-pipe">|</span> <span class="header-breadcrumb">Dashboard</span></h1>
                <button class="register-ipo-btn">Register IPO</button>
            </div>

            <!-- Modal for Registering/Updating IPO -->
            <div id="ipo-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2 id="modal-title">Register IPO</h2>
                    <form id="ipo-form">
                        <input type="hidden" id="ipo-id">
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" id="company-name" required>
                        </div>
                        <div class="form-group">
                            <label for="price-band">Price Band</label>
                            <input type="text" id="price-band" placeholder="e.g., ₹ 100 - ₹ 110">
                        </div>
                        <div class="form-group">
                            <label for="open-date">Open Date</label>
                            <input type="date" id="open-date">
                        </div>
                        <div class="form-group">
                            <label for="close-date">Close Date</label>
                            <input type="date" id="close-date">
                        </div>
                        <div class="form-group">
                            <label for="issue-size">Issue Size</label>
                            <input type="text" id="issue-size" placeholder="e.g., 500 Cr.">
                        </div>
                        <div class="form-group">
                            <label for="issue-type">Issue Type</label>
                            <input type="text" id="issue-type" value="Book Built">
                        </div>
                        <div class="form-group">
                            <label for="listing-date">Listing Date</label>
                            <input type="date" id="listing-date">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="Coming">Coming</option>
                                <option value="Ongoing">Ongoing</option>
                                <option value="New Listed">New Listed</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save IPO</button>
                    </form>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- IPO Dashboard India Section -->
                <div class="widget ipo-dashboard">
                    <h2>IPO Dashboard India</h2>
                    
                    <!-- Table for IPO data -->
                    <div class="ipo-table-container">
                        <table class="ipo-table">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Price Band</th>
                                    <th>Open</th>
                                    <th>Close</th>
                                    <th>Issue Size</th>
                                    <th>Issue Type</th>
                                    <th>Listing Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                    <th>Delete/View</th>
                                </tr>
                            </thead>
                            <tbody id="ipo-table-body">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
<script>
// IPO Data Management with CRUD Operations
let ipoData = [
  { id: 1, company: "Adani Power", price_band: "₹ 329 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "45530.15 Cr.", issue_type: "Book Built", listing_date: "2023-06-10", status: "Ongoing" },
  { id: 2, company: "VBL LTD", price_band: "₹ 229 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "1330.15 Cr.", issue_type: "Book Built", listing_date: "2018-06-10", status: "Coming" },
  { id: 3, company: "Tata Motor", price_band: "₹ 12549 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "1340.15 Cr.", issue_type: "Book Built", listing_date: "2016-06-10", status: "New Listed" },
  { id: 4, company: "HDFC LTD", price_band: "₹ 1244 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "830.15 Cr.", issue_type: "Book Built", listing_date: "2029-06-11", status: "Coming" },
  { id: 5, company: "Tata Motor", price_band: "₹ 629 - 136", open: "2024-06-01", close: "2024-06-05", issue_size: "820.15 Cr.", issue_type: "Book Built", listing_date: "2024-06-05", status: "Ongoing" },
  { id: 6, company: "VBL LTD", price_band: "₹ 629 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "130.15 Cr.", issue_type: "Book Built", listing_date: "2024-06-10", status: "Coming" },
  { id: 7, company: "Tata Motor", price_band: "₹ 6729 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "170.15 Cr.", issue_type: "Book Built", listing_date: "2027-06-10", status: "New Listed" },
  { id: 8, company: "VBL LTD", price_band: "₹ 1629 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "130.15 Cr.", issue_type: "Book Built", listing_date: "2022-06-10", status: "Coming" },
  { id: 9, company: "Tata Motor", price_band: "₹ 2329 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "130.15 Cr.", issue_type: "Book Built", listing_date: "2023-06-10", status: "New Listed" },
  { id: 10, company: "VBL LTD", price_band: "₹ 329 - 136", open: "2024-06-03", close: "2024-06-05", issue_size: "130.15 Cr.", issue_type: "Book Built", listing_date: "2021-06-10", status: "Coming" }
];

let nextId = 11; // For generating new IDs

// Status badge class mapping
const statusBadgeClasses = {
  "Ongoing": "ongoing",
  "Coming": "coming", 
  "New Listed": "new-listed"
};

// CRUD Operations

// CREATE - Add new IPO
function createIPO(ipoDetails) {
  const newIPO = {
    id: nextId++,
    company: ipoDetails.company,
    price_band: ipoDetails.priceBand,
    open: ipoDetails.openDate,
    close: ipoDetails.closeDate,
    issue_size: ipoDetails.issueSize,
    issue_type: ipoDetails.issueType,
    listing_date: ipoDetails.listingDate,
    status: ipoDetails.status
  };
  
  ipoData.push(newIPO);
  renderIpoTable();
  
  // Show success message
  showNotification('IPO created successfully!', 'success');
  
  return newIPO;
}

// READ - Get IPO by ID
function getIPOById(id) {
  return ipoData.find(ipo => ipo.id === parseInt(id));
}

// UPDATE - Update existing IPO
function updateIPO(id, updatedDetails) {
  const index = ipoData.findIndex(ipo => ipo.id === parseInt(id));
  
  if (index !== -1) {
    ipoData[index] = {
      ...ipoData[index],
      company: updatedDetails.company,
      price_band: updatedDetails.priceBand,
      open: updatedDetails.openDate,
      close: updatedDetails.closeDate,
      issue_size: updatedDetails.issueSize,
      issue_type: updatedDetails.issueType,
      listing_date: updatedDetails.listingDate,
      status: updatedDetails.status
    };
    
    renderIpoTable();
    showNotification('IPO updated successfully!', 'success');
    
    return ipoData[index];
  }
  
  return null;
}

// DELETE - Remove IPO
function deleteIPO(id) {
  const index = ipoData.findIndex(ipo => ipo.id === parseInt(id));
  
  if (index !== -1) {
    const deletedIPO = ipoData.splice(index, 1)[0];
    renderIpoTable();
    showNotification('IPO deleted successfully!', 'success');
    
    return deletedIPO;
  }
  
  return null;
}

// Render IPO Table with CRUD action buttons
function renderIpoTable() {
  const tbody = document.getElementById('ipo-table-body');
  tbody.innerHTML = '';
  
  ipoData.forEach(ipo => {
    const statusClass = statusBadgeClasses[ipo.status] || '';
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ipo.company}</td>
      <td>${ipo.price_band}</td>
      <td>${ipo.open}</td>
      <td>${ipo.close}</td>
      <td>${ipo.issue_size}</td>
      <td>${ipo.issue_type}</td>
      <td>${ipo.listing_date}</td>
      <td><span class="status-badge ${statusClass}">${ipo.status}</span></td>
      <td>
        <button class="action-btn update-btn" data-id="${ipo.id}">
          Update
        </button>
      </td>
      <td>
        <i class="fa-solid fa-trash delete-btn" data-id="${ipo.id}" title="Delete IPO"></i>
        <i class="fa-solid fa-eye view-btn" data-id="${ipo.id}" title="View IPO Details"></i>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // Add event listeners for CRUD operations
  addCRUDEventListeners();
}

// Add event listeners for CRUD operations
function addCRUDEventListeners() {
  // Update button listeners
  document.querySelectorAll('.update-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      openUpdateModal(id);
    });
  });
  
  // Delete button listeners
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      confirmDelete(id);
    });
  });
  
  // View button listeners
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      viewIPODetails(id);
    });
  });
}

// Open modal for updating IPO
function openUpdateModal(id) {
  const ipo = getIPOById(id);
  if (!ipo) return;
  
  const modal = document.getElementById('ipo-modal');
  const modalTitle = document.getElementById('modal-title');
  
  // Populate form with existing data
  document.getElementById('ipo-id').value = ipo.id;
  document.getElementById('company-name').value = ipo.company;
  document.getElementById('price-band').value = ipo.price_band;
  document.getElementById('open-date').value = ipo.open;
  document.getElementById('close-date').value = ipo.close;
  document.getElementById('issue-size').value = ipo.issue_size;
  document.getElementById('issue-type').value = ipo.issue_type;
  document.getElementById('listing-date').value = ipo.listing_date;
  document.getElementById('status').value = ipo.status;
  
  modalTitle.textContent = 'Update IPO';
  modal.style.display = 'block';
}

// Confirm delete operation
function confirmDelete(id) {
  const ipo = getIPOById(id);
  if (!ipo) return;
  
  if (confirm(`Are you sure you want to delete ${ipo.company}? This action cannot be undone.`)) {
    deleteIPO(id);
  }
}

// View IPO details in a modal/alert
function viewIPODetails(id) {
  const ipo = getIPOById(id);
  if (!ipo) return;
  
  const details = `
IPO Details:
━━━━━━━━━━━━━━━━━━━━
Company: ${ipo.company}
Price Band: ${ipo.price_band}
Open Date: ${ipo.open}
Close Date: ${ipo.close}
Issue Size: ${ipo.issue_size}
Issue Type: ${ipo.issue_type}
Listing Date: ${ipo.listing_date}
Status: ${ipo.status}
━━━━━━━━━━━━━━━━━━━━
  `;
  
  alert(details);
}

// Show notification messages
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  
  // Style the notification
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
    ${type === 'success' ? 'background-color: #10b981;' : ''}
    ${type === 'error' ? 'background-color: #ef4444;' : ''}
    ${type === 'info' ? 'background-color: #3b82f6;' : ''}
  `;
  
  document.body.appendChild(notification);
  
  // Remove notification after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Add CSS animation for notifications
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Initial render
renderIpoTable();
</script>

                    </div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="page-arrow" disabled>&lt;</button>
                        <button class="page-number active">1</button>
                        <button class="page-number">2</button>
                        <span class="page-ellipsis">...</span>
                        <button class="page-number">9</button>
                        <button class="page-number">10</button>
                        <button class="page-arrow">&gt;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleDropdown() {
            document.getElementById('userDropdownMenu').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Bluestock DEBUG] DOMContentLoaded event fired');
            
            // Initialize router for navigation
            if (window.bluestockRouter) {
                console.log('[Bluestock DEBUG] Router found, initializing navigation handlers');
                
                // Initialize the router
                if (typeof window.bluestockRouter.init === 'function') {
                    window.bluestockRouter.init();
                }
                
                // Add click handlers for navigation links
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a[data-route]');
                    if (link) {
                        e.preventDefault();
                        const route = link.getAttribute('data-route');
                        console.log('[Bluestock DEBUG] Navigating to route:', route);
                        window.bluestockRouter.navigate(route);
                    }
                });
            } else {
                console.error('[Bluestock DEBUG] window.bluestockRouter is not defined!');
                
                // Fallback navigation handling
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a[data-route]');
                    if (link) {
                        e.preventDefault();
                        const route = link.getAttribute('data-route');
                        console.log('[Manage IPO] Fallback navigation to:', route);
                        
                        // Manual routing fallback
                        const routes = {
                            'dashboard': '/components/dashboard/admin-dashboard.html',
                            'manage-ipo': '/components/dashboard/manage-ipo.html'
                        };
                        
                        if (routes[route]) {
                            window.location.href = routes[route];
                        }
                    }
                });
            }
            
            // User dropdown toggle
            const userDropdownToggles = document.querySelectorAll('.user-dropdown-toggle');
            const userDropdownMenu = document.getElementById('userDropdownMenu');
            
            userDropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    userDropdownMenu.classList.toggle('show');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.matches('.user-dropdown-toggle') && !e.target.closest('.user-dropdown-menu')) {
                    if (userDropdownMenu && userDropdownMenu.classList.contains('show')) {
                        userDropdownMenu.classList.remove('show');
                    }
                }
            });
        });
    </script>
    <script>
        // Fallback Supabase client initialization (allows hard refresh)
        const SUPABASE_URL = 'https://pyxqwiqvyivyopusgcey.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eHF3aXF2eWl2eW9wdXNnY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwOTE1NzEsImV4cCI6MjA2MzY2NzU3MX0.vJEoejN1jgHeU5hcvujKMVuWCHkIy7010N76WXg3_1s';
        if (!window.supabaseClient && window.supabase) {
            window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true
                }
            });
            console.log('[Bluestocks] Supabase client (fallback) initialised in manage-ipo.html');
        }

        // Immediately use the global Supabase client
        (function() {
            const supabase = window.supabaseClient;
            if (!supabase) {
                console.error('Supabase client not initialized. Auth features may not work.');
                return;
            }
            try {
                
                // Check session immediately
                window.supabaseClient.auth.getSession().then(({ data, error }) => {
                    if (!error && data && data.session) {
                        // Store session data globally
                        window.authSession = data.session;
                        
                        // Get user data
                        window.supabaseClient.auth.getUser().then(({ data: userData, error: userError }) => {
                            if (!userError && userData && userData.user) {
                                // Store user data globally
                                window.currentUser = userData.user;
                                // Store user metadata for easy access
                                window.userMetadata = userData.user.user_metadata || {};
                            }
                        });
                    }
                });
            } catch (e) {
                // Silent error handling in production
            }
        })();
    </script>
    <script>
        function toggleDropdown() {
            document.getElementById('userDropdownMenu').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userElement = document.querySelector('.user-info .user');
            const companyBrand = document.getElementById('company-brand');
            
            // Link both company brand and user dropdown arrow to toggle the dropdown
            if (userElement) userElement.addEventListener('click', toggleDropdown);
            if (companyBrand) companyBrand.addEventListener('click', toggleDropdown);
            
            // Close dropdown if clicked outside
            window.onclick = function(event) {
                if (!event.target.matches('.user-dropdown-toggle')) {
                    var dropdowns = document.getElementsByClassName("user-dropdown-menu");
                    for (var i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }

            // Function to update user display name from auth system
            async function updateUserName() {
                try {
                    // Use the global Supabase client
                    if (!window.supabaseClient) {
                        console.error('Supabase client not available for updating user name.');
                        return;
                    }

                    const { data, error } = await window.supabaseClient.auth.getUser();

                    if (error) {
                        console.error('Error fetching user:', error.message);
                        return;
                    }

                    if (data && data.user) {
                        const user = data.user;
                        const fullName = user.user_metadata.full_name || 'User';
                        const userDisplayName = document.getElementById('userDisplayName');
                        if (userDisplayName) {
                            userDisplayName.textContent = `Hi, ${fullName}`;
                        }
                        
                        // Store name in localStorage for faster subsequent loads
                        localStorage.setItem('bluestock_user_name', fullName);
                    } else {
                        // Fallback to localStorage if no active session
                        const savedName = localStorage.getItem('bluestock_user_name');
                        if (savedName) {
                            const userDisplayName = document.getElementById('userDisplayName');
                            if (userDisplayName) {
                                userDisplayName.textContent = `Hi, ${savedName}`;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Failed to update user name:', e.message);
                }
            }

            // User authentication check
            async function checkAuthenticationAndRedirect() {
                try {
                    if (!window.supabaseClient) {
                        console.error('Supabase client not initialized, redirecting to IPO page');
                        window.location.href = '/ipo.html?from=no-client';
                        return;
                    }

                    const { data, error } = await window.supabaseClient.auth.getSession();
                    
                    if (error) {
                        console.error('Error getting session:', error.message);
                        window.location.href = '/ipo.html?from=session-error';
                        return;
                    }
                    
                    if (!data || !data.session) {
                        console.log('No active session found. Redirecting to sign-in page.');
                        window.location.href = '/components/auth/signin.html?redirect=manage-ipo';
                        return;
                    }
                    
                    console.log('User authenticated successfully');
                    // User is authenticated, continue with page initialization
                    await updateUserName();
                    
                } catch (e) {
                    console.error('Exception during authentication check:', e.message);
                    window.location.href = '/ipo.html?from=auth-exception';
                }
            }
            
            // Run authentication check and related logic in an async IIFE
            (async function() {
                await checkAuthenticationAndRedirect();

                // Sample data for the IPO table
                const ipoData = [
                    { company: 'Adani Power', priceBand: '₹ 329 - 136', open: '2023-06-03', close: '2024-06-05', issueSize: '45530.15 Cr.', issueType: 'Book Built', listingDate: '2023-06-10', status: 'Ongoing' },
                    { company: 'VBL LTD', priceBand: '₹ 229 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '1330.15 Cr.', issueType: 'Book Built', listingDate: '2018-06-10', status: 'Coming' },
                    { company: 'Tata Motor', priceBand: '₹ 12549 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '1340.15 Cr.', issueType: 'Book Built', listingDate: '2016-06-10', status: 'New Listed' },
                    { company: 'HDFC LTD', priceBand: '₹ 1244 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '830.15 Cr.', issueType: 'Book Built', listingDate: '2029-06-11', status: 'Coming' },
                    { company: 'Tata Motor', priceBand: '₹ 629 - 136', open: '2024-06-01', close: '2024-06-05', issueSize: '820.15 Cr.', issueType: 'Book Built', listingDate: '2023-06-10', status: 'Ongoing' },
                    { company: 'VBL LTD', priceBand: '₹ 629 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '130.15 Cr.', issueType: 'Book Built', listingDate: '2024-06-10', status: 'Coming' },
                    { company: 'Tata Motor', priceBand: '₹ 6729 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '170.15 Cr.', issueType: 'Book Built', listingDate: '2027-06-10', status: 'New Listed' },
                    { company: 'VBL LTD', priceBand: '₹ 1629 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '130.15 Cr.', issueType: 'Book Built', listingDate: '2022-06-10', status: 'Coming' },
                    { company: 'Tata Motor', priceBand: '₹ 2329 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '130.15 Cr.', issueType: 'Book Built', listingDate: '2023-06-10', status: 'New Listed' },
                    { company: 'VBL LTD', priceBand: '₹ 329 - 136', open: '2024-06-03', close: '2024-06-05', issueSize: '130.15 Cr.', issueType: 'Book Built', listingDate: '2021-06-10', status: 'Coming' },
                ];

                const tableBody = document.getElementById('ipo-table-body');
                ipoData.forEach(ipo => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ipo.company}</td>
                        <td>${ipo.priceBand}</td>
                        <td>${ipo.open}</td>
                        <td>${ipo.close}</td>
                        <td>${ipo.issueSize}</td>
                        <td>${ipo.issueType}</td>
                        <td>${ipo.listingDate}</td>
                        <td><span class="status-badge status-${ipo.status.toLowerCase().replace(' ', '-')}">${ipo.status}</span></td>
                        <td><button class="action-btn update-btn">Update</button></td>
                        <td>
                            <button class="action-icon delete-icon"><i class="fa-solid fa-trash-can"></i></button>
                            <button class="action-icon view-icon"><i class="fa-solid fa-eye"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })();

            // Logout functionality
            const logoutButton = document.getElementById('logoutBtn');
            if (logoutButton) {
                logoutButton.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Logout button clicked');
                    try {
                        if (!window.supabaseClient) {
                            console.error('Supabase client not initialized for logout.');
                            return;
                        }
                        const { error } = await window.supabaseClient.auth.signOut();
                        if (error) {
                            console.error('Error during sign out:', error.message);
                            alert('Logout failed. Please try again.');
                        } else {
                            console.log('Successfully signed out.');
                            // Clear local storage for user data
                            localStorage.removeItem('bluestock_user_name');
                            // Redirect to the main IPO page after successful logout
                            window.location.href = '/ipo.html?from=logout'; 
                        }
                    } catch (e) {
                        console.error('Exception during sign out:', e.message);
                        alert('An unexpected error occurred during logout.');
                    }
                });
            }

            // Register IPO button and modal functionality
            const registerIpoBtn = document.querySelector('.register-ipo-btn');
            const ipoModal = document.getElementById('ipo-modal');
            const closeButton = document.querySelector('.close-button');
            const ipoForm = document.getElementById('ipo-form');
            
            if (registerIpoBtn) {
                registerIpoBtn.addEventListener('click', function() {
                    ipoModal.style.display = 'block';
                    document.getElementById('modal-title').textContent = 'Register IPO';
                    ipoForm.reset();
                    document.getElementById('ipo-id').value = '';
                });
            }
            
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    ipoModal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === ipoModal) {
                    ipoModal.style.display = 'none';
                }
            });
            
            // Handle form submission for both CREATE and UPDATE operations
            if (ipoForm) {
                ipoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        company: document.getElementById('company-name').value,
                        priceBand: document.getElementById('price-band').value,
                        openDate: document.getElementById('open-date').value,
                        closeDate: document.getElementById('close-date').value,
                        issueSize: document.getElementById('issue-size').value,
                        issueType: document.getElementById('issue-type').value,
                        listingDate: document.getElementById('listing-date').value,
                        status: document.getElementById('status').value
                    };
                    
                    // Validate required fields
                    if (!formData.company.trim()) {
                        alert('Company name is required!');
                        return;
                    }
                    
                    const ipoId = document.getElementById('ipo-id').value;
                    
                    if (ipoId) {
                        // UPDATE operation
                        updateIPO(ipoId, formData);
                    } else {
                        // CREATE operation
                        createIPO(formData);
                    }
                    
                    // Close modal and reset form
                    ipoModal.style.display = 'none';
                    ipoForm.reset();
                    document.getElementById('ipo-id').value = '';
                });
            }
            
            // ...existing code... */
        });

        // Fallback for logout button if it's in a dropdown that might not be immediately available
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
    logoutBtn.addEventListener('click', async function() {
        console.log('Logout button clicked');
        
        // Close the dropdown menu
        const dropdown = document.getElementById('userDropdownMenu');
        if (dropdown) dropdown.classList.remove('show');

        try {
            // Clear authentication state from localStorage
            localStorage.removeItem('bluestock_user_authenticated');
            localStorage.removeItem('bluestock_user_email');
            localStorage.removeItem('bluestock_user_name');
            
            // Clear session flags
            sessionStorage.removeItem('adminDashboardLoaded');
            sessionStorage.removeItem('adminDashboardDirectLoad');
            
            // Use router logout if available
            if (window.bluestockRouter && typeof window.bluestockRouter.signOut === 'function') {
                console.log('Using router signOut method');
                await window.bluestockRouter.signOut();
                return; // Router will handle redirection
            }
            
            // Fallback (if router not available):
            if (window.supabaseClient) {
                console.log('Using direct Supabase signOut');
                await window.supabaseClient.auth.signOut();
            }
            
            // Direct redirection to IPO page
            console.log('Redirecting to IPO page');
            window.location.href = '/ipo.html?from=logout';
        } catch (error) {
            console.error('Error signing out:', error);
            // Ensure redirection even if there's an error
            window.location.href = '/ipo.html?from=logout';
        }
    });
}

    </script>
</body>
</html>
