<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bluestock Fintech</title>
    <!-- Authentication persistence handler - loads first to prevent redirect issues -->    <script src="../../js/admin-auth-persistence.js"></script>
    <link rel="stylesheet" href="../../styles/dashboard/admin-dashboard.css">
    <link rel="stylesheet" href="../../styles/dashboard/dropdown.css">
    <link rel="stylesheet" href="../../styles/dashboard/dropdown-reset.css">
    <!-- Using Font Awesome 6 for all icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load Supabase JavaScript SDK first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Directly initialize Supabase and check auth state -->
    <script>
        // Fallback initialization ensures Supabase client exists even when this page is loaded directly (e.g. browser hard refresh)
        const SUPABASE_URL = 'https://pyxqwiqvyivyopusgcey.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5eHF3aXF2eWl2eW9wdXNnY2V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwOTE1NzEsImV4cCI6MjA2MzY2NzU3MX0.vJEoejN1jgHeU5hcvujKMVuWCHkIy7010N76WXg3_1s';
        
        // Check for authentication on direct page load (critical for persistence)
        if (window.location.href.includes('admin-dashboard')) {
            // First, set a flag to prevent redirect loops
            sessionStorage.setItem('adminDashboardDirectLoad', 'true');
            sessionStorage.setItem('adminDashboardLoaded', 'true');
            
            // Check for auth token to quickly verify if user might be authenticated
            const hasAuthToken = !!localStorage.getItem('sb-pyxqwiqvyivyopusgcey-auth-token');
            const hasBluestockAuth = localStorage.getItem('bluestock_user_authenticated') === 'true';
            const hasUserEmail = !!localStorage.getItem('bluestock_user_email');
            
            console.log('[Auth Debug] Direct admin dashboard load - Auth indicators:', {
                token: hasAuthToken,
                bluestockAuth: hasBluestockAuth,
                email: hasUserEmail
            });
            
            if (!hasAuthToken && !hasBluestockAuth && !hasUserEmail) {
                console.log('[Auth Debug] No auth indicators found, redirecting to signin');
                window.location.href = '/components/auth/signin.html';
            }
        }
        
        if (!window.supabaseClient && window.supabase) {
            window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true,
                    storageKey: 'sb-pyxqwiqvyivyopusgcey-auth-token'
                }
            });
            console.log('[Bluestocks] Supabase client (fallback) initialised in admin-dashboard.html early');
        }
        
        // User name update - Apply the name as soon as page starts loading
        (function() {
            // Function to update the user name
            function updateUserName() {
                try {
                    // Direct DOM manipulation
                    var nameElement = document.getElementById('userDisplayName');
                    if (!nameElement) {
                        return false;
                    }
                    
                    // 1. First try: Use directly from metadata in window object
                    if (window.userMetadata && window.userMetadata.full_name) {
                        nameElement.innerHTML = 'Hi, ' + window.userMetadata.full_name;
                        return true;
                    }
                    
                    // 2. Second try: Use from localStorage
                    var savedName = localStorage.getItem('bluestock_user_name');
                    if (savedName) {
                        nameElement.innerHTML = 'Hi, ' + savedName;
                        return true;
                    }
                    
                    // 3. Third try: Get directly from Supabase
                    if (window.supabaseClient) {
                        window.supabaseClient.auth.getUser().then(function(response) {
                            if (response && response.data && response.data.user && 
                                response.data.user.user_metadata && 
                                response.data.user.user_metadata.full_name) {
                                
                                nameElement.innerHTML = 'Hi, ' + response.data.user.user_metadata.full_name;
                                
                                // Save for future use
                                localStorage.setItem('bluestock_user_name', response.data.user.user_metadata.full_name);
                            }
                        });
                    }
                    
                    return false; // We couldn't immediately update, but async update might be happening
                } catch (e) {
                    return false;
                }
            }
            
            // Run immediately
            var updated = updateUserName();
            
            // If not updated immediately, set up retries
            if (!updated) {
                var retryAttempts = 0;
                var retryInterval = setInterval(function() {
                    retryAttempts++;
                    
                    if (updateUserName() || retryAttempts > 20) {
                        clearInterval(retryInterval);
                    }
                }, 200); // Try every 200ms
            }
        })();
        
        // Immediately use the global Supabase client
        (function() {
            const supabase = window.supabaseClient;
            if (!supabase) {
                console.error('Supabase client not initialized. Certain authenticated features may not work.');
                return;
            }
            try {
                
                // Check session immediately
                window.supabaseClient.auth.getSession().then(({ data, error }) => {
                    if (!error && data && data.session) {
                        // Store session data globally
                        window.authSession = data.session;
                        
                        // Get user data
                        window.supabaseClient.auth.getUser().then(({ data: userData, error: userError }) => {
                            if (!userError && userData && userData.user) {
                                // Store user data globally
                                window.currentUser = userData.user;
                                // Store user metadata for easy access
                                window.userMetadata = userData.user.user_metadata || {};
                            }
                        });
                    }
                });
            } catch (e) {
                // Silent error handling in production
            }
        })();
    </script>
    <!-- Then load our auth.js which depends on it -->
    <script src="../../js/auth.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="brand" id="company-brand">
                <div class="company-logo">BF</div>
                <span>Bluestock Fintech</span>
            </div>
            
            <div class="menu-header">MENU</div>
            <nav class="menu">
                <a href="#" data-route="dashboard" class="active"><i class="fa-solid fa-table-cells-large"></i> Dashboard</a>
                <a href="#" data-route="manage-ipo"><i class="fa-solid fa-list-check"></i> Manage IPO</a>
                <a href="#"><i class="fa-solid fa-file-invoice"></i> IPO Subscription</a>
                <a href="#"><i class="fa-solid fa-chart-pie"></i> IPO Allotment</a>
            </nav>
            
            <div class="menu-header">OTHERS</div>
            <nav class="menu">
                <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
                <a href="#"><i class="fa-solid fa-plug"></i> API Manager</a>
                <a href="#"><i class="fa-solid fa-users"></i> Accounts</a>
                <a href="#"><i class="fa-solid fa-circle-question"></i> Help</a>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Search and User Info -->
            <div class="header">
                <div class="search-bar">
                    <input type="text" placeholder="Search" class="search-input">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                </div>
                <div class="user-info">
                    <div class="user">
                        <div class="user-avatar">
                            <div class="avatar-circle"></div>
                        </div>                        <div class="user-dropdown-container">
                            <span id="userDisplayName" class="user-dropdown-toggle" tabindex="0">Hi, User</span>                            <i class="fa-solid fa-chevron-down user-dropdown-toggle" tabindex="0"></i>
                            <div id="userDropdownMenu" class="user-dropdown-menu">
                                <button id="logoutBtn" class="logout-btn">
                                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                        <!-- Direct name update script -->
                        <script>
                            // Immediate execution to update name right where it appears in the DOM
                            (function() {
                                try {
                                    // Wait just a moment for the Supabase init to complete
                                    setTimeout(function() {
                                        // Direct access to the element we just defined above
                                        var userNameEl = document.getElementById('userDisplayName');
                                        
                                        // Method 1: Use the metadata we just stored in the head section
                                        if (window.userMetadata && window.userMetadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.userMetadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 2: Try to get from currentUser
                                        if (window.currentUser && window.currentUser.user_metadata && 
                                            window.currentUser.user_metadata.full_name) {
                                            userNameEl.textContent = 'Hi, ' + window.currentUser.user_metadata.full_name;
                                            return;
                                        }
                                        
                                        // Method 3: Direct Supabase query
                                        if (window.supabaseClient) {
                                            window.supabaseClient.auth.getUser().then(function(result) {
                                                if (result && result.data && result.data.user && 
                                                    result.data.user.user_metadata && 
                                                    result.data.user.user_metadata.full_name) {
                                                    userNameEl.textContent = 'Hi, ' + result.data.user.user_metadata.full_name;
                                                }
                                            });
                                        }
                                    }, 200); // Small delay to ensure the element is fully rendered
                                } catch(e) {
                                    // Silent error handling in production
                                }
                            })();
                        </script>
                    </div>
                    <div class="notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Title and Social Icons -->
            
            <!-- Dashboard Title -->
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h1>Dashboard</h1>
                </div>
            </div>
            
            
            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- IPO Dashboard India Section -->
                <div class="widget ipo-dashboard">
                    <h2>IPO Dashboard India</h2>
                    
                    <div class="ipo-stats">
                        <p class="stat-item"><span class="arrow-up">↑</span> 20 IPO in Gain</p>
                    </div>                    <div class="ipo-image-charts">
                        <div class="ipo-image-chart-item chart-loss">
                            <img src="../../images/icons/chart-1.png" alt="IPO in Loss Chart">
                            <div>
                                <div class="chart-number">9</div>
                                <div class="chart-text">IPO in Loss</div>
                            </div>
                        </div>
                        <div class="ipo-image-chart-item chart-gain">
                            <img src="../../images/icons/chart-2.png" alt="IPO in Gain Chart">
                            <div>
                                <div class="chart-number">20</div>
                                <div class="chart-text">IPO in Gain</div>
                            </div>
                        </div>
                        <div class="ipo-image-chart-item chart-total">
                            <img src="../../images/icons/chart-3.png" alt="Total IPO Chart">
                            <div>
                                <div class="chart-number">30</div>
                                <div class="chart-text">Total IPO</div>
                            </div>
                        </div>
                    </div>
                </div>
                  <!-- Quick Links Section -->
                <div class="widget quick-links">
                    <h2>Quick Links</h2>
                    <p>Adipiscing elit, sed do eiusmod tempor</p>
                    
                    <ul class="links-list">
                        <li>
                            <div class="link-icon nse"><img src="../../images/Company LOGO/NSE.png" alt="NSE Logo" /></div>
                            <div class="link-text">NSE India</div>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon bse"><img src="../../images/Company LOGO/BSE.png" alt="BSE Logo" /></div>
                            <div class="link-text">BSE India</div>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon sebi"><img src="../../images/Company LOGO/SEBI.png" alt="SEBI Logo" /></div>
                            <div class="link-text">SEBI</div>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                        <li>
                            <div class="link-icon money-control"><img src="../../images/Company LOGO/moneyControl.png" alt="Money Control Logo" /></div>
                            <div class="link-text">Money Control</div>
                            <a href="#" class="visit-now">Visit Now</a>
                        </li>
                    </ul>
                </div>
                  <!-- Main Board IPO -->
                <div class="widget main-board">
                    <div class="board-header">
                        <div>
                            <h2>Main Board IPO</h2>
                            <p class="board-subtitle">From 01 Jan 2024</p>
                        </div>
                        <a href="#" class="view-report">View Report</a>
                    </div>
                      <div class="donut-chart-container">
                        <canvas id="mainBoardDonutChart"></canvas>
                        <div class="chart-tooltip">
                            <p class="tooltip-title">Afternoon</p>
                            <p class="tooltip-subtitle">IPO NSE & BSE</p>
                            <p class="tooltip-value">15</p>
                        </div>
                    </div>
                    
                    <div class="main-board-legend">
                        <div class="legend-item">
                            <span class="legend-dot upcoming"></span>
                            <span class="legend-label">Upcoming</span>
                            <span class="legend-count">15</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot new-listed"></span>
                            <span class="legend-label">New Listed</span>
                            <span class="legend-count">25</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot ongoing"></span>
                            <span class="legend-label">Ongoing</span>
                            <span class="legend-count">2</span>
                        </div>
                    </div>
                    
                    <!-- Chart.js script for Main Board IPO donut chart -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const ctx = document.getElementById('mainBoardDonutChart').getContext('2d');
                            const mainBoardDonutChart = new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Upcoming', 'New Listed', 'Ongoing'],
                                    datasets: [{
                                        data: [15, 25, 2],
                                        backgroundColor: [
                                            '#6366F1', // Upcoming - darker blue
                                            '#A5B4FC', // New Listed - medium blue
                                            '#E0E7FF'  // Ongoing - light blue
                                        ],
                                        borderWidth: 0,
                                        cutout: '70%'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            enabled: false
                                        }
                                    }
                                }
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>    <script>        document.addEventListener('DOMContentLoaded', function() {
            // User dropdown toggle - Simplified implementation
            const userDropdownToggles = document.querySelectorAll('.user-dropdown-toggle');
            const userDropdownMenu = document.getElementById('userDropdownMenu');
            
            if (userDropdownToggles.length > 0 && userDropdownMenu) {
                // Add click event to toggle elements
                userDropdownToggles.forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        userDropdownMenu.classList.toggle('show');
                    });
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    const isClickInside = e.target.closest('.user-dropdown-container');
                    if (!isClickInside && userDropdownMenu.classList.contains('show')) {
                        userDropdownMenu.classList.remove('show');
                    }
                });
            }
            
            // Logout button logic
            const logoutBtn = document.getElementById('logoutBtn');            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    // Close the dropdown menu
                    const dropdown = document.getElementById('userDropdownMenu');
                    if (dropdown) dropdown.classList.remove('show');
            
                    try {
                        // Clear authentication state from localStorage
                        localStorage.removeItem('bluestock_user_authenticated');
                        localStorage.removeItem('bluestock_user_email');
                        localStorage.removeItem('bluestock_user_name');
                        
                        // Clear session flags
                        sessionStorage.removeItem('adminDashboardLoaded');
                        sessionStorage.removeItem('adminDashboardDirectLoad');
                        
                        // Use router logout if available
                        if (window.bluestockRouter && typeof window.bluestockRouter.signOut === 'function') {
                            await window.bluestockRouter.signOut();
                            return; // Router will handle redirection
                        }
                        
                        // Fallback (if router not available):
                        if (window.supabaseClient) {
                            await window.supabaseClient.auth.signOut();
                        }
                        // Direct redirection to IPO page
                        window.location.href = '/ipo.html?from=logout';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        // Ensure redirection even if there's an error
                        window.location.href = '/ipo.html?from=logout';
                    }
                });
            }
        });    </script>    <script src="../../js/router.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {            console.log('[Admin Dashboard] DOM loaded, initializing router...');
            
            // Add debugging for all navigation links
            const navLinks = document.querySelectorAll('a[data-route]');
            console.log('[Admin Dashboard] Found navigation links:', navLinks.length);
            navLinks.forEach((link, index) => {
                const route = link.getAttribute('data-route');
                console.log(`[Admin Dashboard] Link ${index}: ${route}`);
                
                link.addEventListener('click', function(e) {
                    console.log(`[Admin Dashboard] Direct click handler for ${route}`);
                });
            });
            
            // Initialize router if not already done
            if (window.bluestockRouter) {
                console.log('[Admin Dashboard] Router found, ensuring initialization');
                if (typeof window.bluestockRouter.init === 'function') {
                    window.bluestockRouter.init();
                }
                
                // Add extra navigation handling as backup
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a[data-route]');
                    if (link) {
                        const route = link.getAttribute('data-route');
                        console.log('[Admin Dashboard] Manual navigation to:', route);
                        e.preventDefault();
                        if (window.bluestockRouter && typeof window.bluestockRouter.navigate === 'function') {
                            window.bluestockRouter.navigate(route);
                        } else {
                            console.error('[Admin Dashboard] Router navigate function not available');
                        }
                    }
                });
            } else {
                console.error('[Admin Dashboard] window.bluestockRouter is not defined!');
                
                // Fallback for manual navigation
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a[data-route]');
                    if (link) {
                        e.preventDefault();
                        const route = link.getAttribute('data-route');
                        console.log('[Admin Dashboard] Fallback navigation to:', route);
                        
                        // Manual routing fallback
                        const routes = {
                            'dashboard': '/components/dashboard/admin-dashboard.html',
                            'manage-ipo': '/components/dashboard/manage-ipo.html'
                        };
                        
                        if (routes[route]) {
                            window.location.href = routes[route];
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
