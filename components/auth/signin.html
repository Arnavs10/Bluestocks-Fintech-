<!-- BLUESTOCK Sign In Component -->
<!-- This component is designed to be loaded dynamically into a container -->
<link rel="stylesheet" href="../../styles/admin/signin.css">
    <div class="signin-container">
        <div class="logo-container">
            <img src="../../images/logo.png" alt="BLUESTOCK Logo" class="logo">
            <h1 class="brand-name">BLUESTOCK</h1>
        </div>
        
        <h2>Sign in</h2>
        
        <form id="signinForm">
            <div class="input-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="hello@bluestock.in" required>
            </div>
            
            <div class="input-group">
                <label for="password">Password</label>
                <div class="password-input-container">
                    <input type="password" id="password" required>
                    <button type="button" id="togglePassword" class="toggle-password">
                        <img src="../../images/eye.svg" alt="Show Password" id="eyeIcon">
                    </button>
                </div>
                <div class="forgot-password">
                    <a href="forgot-password" id="forgotPasswordLink">Forgot Password?</a>
                </div>
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Keep me signed in</label>
            </div>
            
            <!-- reCAPTCHA will be added back later with proper site key -->
            <!-- <div class="captcha-container">
                <div id="recaptcha" class="g-recaptcha"></div>
            </div> -->
            
            <button type="submit" id="signinButton" class="signin-button">Login</button>
            
            <div class="divider">
                <span>or sign in with</span>
            </div>
            
            <button type="button" id="googleSignIn" class="google-button">
                <img src="../../images/google.svg" alt="Google Icon">
                Continue with Google
            </button>
            
            <div class="signup-link">
                <a href="signup" id="createAccountLink">Create an account</a>
            </div>
        </form>
    </div>

    <div id="notification" class="notification hidden">
        <p id="notificationMessage"></p>
    </div>
    
    <!-- Error message container -->
    <div id="errorMessage" class="error-message hidden"></div>

    <!-- Load Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Self-contained authentication script
        (async function() {
            console.log('%c SIGNIN COMPONENT LOADED', 'background: #4CAF50; color: white; font-size: 16px; padding: 4px 8px;');
            
            // Always use the global Supabase client
            let client = window.supabaseClient;
            if (!client) {
                alert('Authentication error: Supabase client not initialized. Please reload the page or contact support.');
                throw new Error('Supabase client not initialized.');
            }
            
            // Client is guaranteed to exist here.
            
            // Test the connection
            client.auth.getSession().then(({ data, error }) => {
                if (error) {
                    console.error('Supabase connection error:', error.message);
                } else {
                    console.log('Supabase connection successful!');
                    
                    // If user is already authenticated, redirect to dashboard
                    if (data && data.session) {
                        console.log('User already authenticated, redirecting to dashboard');
                        // Don't redirect if already on signin page to prevent loops
                        if (window.location.pathname.toLowerCase().replace(/^\/+/, '') === 'signin') {
                            console.log('Already on signin page, not redirecting');
                            return;
                        }
                        
                        // Use the app's routing pattern instead of direct URL
                        if (typeof redirectToPage === 'function') {
                            redirectToPage('admin-dashboard');
                        } else {
                            window.location.href = 'admin-dashboard';
                        }
                    }
                }
            });
            
            // Handle form submission
            const signinForm = document.getElementById('signinForm');
            const signinButton = document.getElementById('signinButton');
            const errorMessage = document.getElementById('errorMessage');
            
            if (signinForm) {
                signinForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Get form values
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    // Basic validation
                    if (!email || !password) {
                        console.error('%c VALIDATION ERROR: Empty fields', 'background: #e74c3c; color: white; font-size: 16px; padding: 4px 8px;');
                        errorMessage.textContent = 'Please fill in all fields';
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                    
                    // Email validation
                    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                    if (!emailRegex.test(email)) {
                        console.error('%c VALIDATION ERROR: Invalid email format', 'background: #e74c3c; color: white; font-size: 16px; padding: 4px 8px;');
                        errorMessage.textContent = 'Please enter a valid email address';
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                    
                    // Show loading state
                    signinButton.disabled = true;
                    signinButton.textContent = 'Signing in...';
                    errorMessage.classList.add('hidden');
                    
                    try {
                        console.log('Attempting sign in with email:', email);
                        
                        // Get remember me preference
                        const rememberMe = document.getElementById('rememberMe');
                        const persistenceType = rememberMe && rememberMe.checked ? 'local' : 'none';
                        
                        console.log('Persistence type:', persistenceType);
                        
                        // Attempt to sign in with persistence option
                        const { data, error } = await client.auth.signInWithPassword({
                            email,
                            password,
                            options: {
                                persistSession: persistenceType === 'local'
                            }
                        });
                        
                        if (error) {
                            console.error('Sign in error:', error);
                            throw error;
                        }
                        
                        // Success!
                        console.log('User signed in successfully:', data.user.email);
                        console.log('User data:', data.user);
                        
                        // Store whether the user chose to be remembered
                        if (rememberMe && rememberMe.checked) {
                            localStorage.setItem('rememberMe', 'true');
                            console.log('User will be remembered (persistent session)');
                        } else {
                            localStorage.removeItem('rememberMe');
                            console.log('User will not be remembered (session only)');
                        }
                        
                        // Success message
                        const notification = document.getElementById('notification');
                        const notificationMessage = document.getElementById('notificationMessage');
                        if (notification && notificationMessage) {
                            notificationMessage.textContent = 'Successfully signed in! Redirecting...';
                            notification.classList.remove('hidden');
                            notification.classList.add('success');
                        }
                        
                        // For now, treat all users as admins
                        console.log('Treating all users as admins for now');
                        
                        // Prevent multiple redirects using global auth state
                        if (window.authState && window.authState.isRedirecting) {
                            console.log('Already redirecting (global state), skipping additional redirect');
                            return;
                        }
                        
                        // Update global auth state
                        if (window.authState) {
                            window.authState.isAuthenticated = true;
                            window.authState.isRedirecting = true;
                            window.authState.user = data.user;
                            window.authState.isAdmin = true; // Treating all users as admins for now
                        } else {
                            // Fallback for backward compatibility
                            window.isRedirecting = true;
                            window.userAuthenticated = true;
                            window.currentUser = data.user;
                        }
                        
                        // Display success message and redirect after a short delay
                        setTimeout(() => {
                            console.log('Redirecting to admin dashboard after successful signin');
                            
                            // Use the redirectToPage helper if available
                            if (typeof redirectToPage === 'function') {
                                redirectToPage('/admin-dashboard');
                            } else {
                                // Otherwise implement redirect logic here
                                try {
                                    // Preferred method: Use SPA routing via global handleRouting function
                                    if (typeof window.handleRouting === 'function') {
                                        console.log('Using SPA routing for admin dashboard redirect');
                                        window.history.pushState({}, '', '/admin-dashboard');
                                        window.handleRouting();
                                    } else {
                                        // Fallback: Use direct navigation
                                        console.log('Using direct navigation for admin dashboard redirect');
                                        window.location.href = '/admin-dashboard';
                                    }
                                } catch (navigationError) {
                                    console.error('Navigation error:', navigationError);
                                    // Ultimate fallback
                                    window.location.href = '/admin-dashboard';
                                }
                                
                                // Reset redirect flag after redirect completes
                                setTimeout(() => {
                                    if (window.authState) {
                                        window.authState.isRedirecting = false;
                                    } else {
                                        window.isRedirecting = false;
                                    }
                                }, 1500);
                            }
                        }, 1000); // Give enough time for users to see the success message
                    } catch (error) {
                        console.error('Sign in error details:', error);
                        
                        // Handle specific error cases with more user-friendly messages
                        if (error.message.includes('invalid')) {
                            // Email format or domain restriction errors
                            errorMessage.textContent = 'This email address cannot be used. Please check your email address.';
                        } else if (error.message.includes('credentials')) {
                            // Invalid credentials
                            errorMessage.textContent = 'Invalid email or password. Please try again.';
                        } else if (error.message.includes('not confirmed')) {
                            // Email not confirmed - provide resend option
                            const resendLink = document.createElement('a');
                            resendLink.href = '#';
                            resendLink.textContent = 'Resend confirmation email';
                            resendLink.style.marginLeft = '5px';
                            resendLink.style.color = '#6366F1';
                            resendLink.style.textDecoration = 'underline';
                            resendLink.style.cursor = 'pointer';
                            
                            resendLink.addEventListener('click', async (e) => {
                                e.preventDefault();
                                try {
                                    // Use the correct Supabase v2 API method for resending confirmation
                                    const { error: resendError } = await client.auth.resendConfirmationEmail({
                                        email: email
                                    });
                                    
                                    if (resendError) {
                                        console.error('Error resending confirmation:', resendError);
                                        errorMessage.textContent = 'Failed to resend confirmation email. ' + resendError.message;
                                    } else {
                                        errorMessage.textContent = 'Confirmation email resent. Please check your inbox.';
                                    }
                                } catch (resendError) {
                                    console.error('Exception resending confirmation:', resendError);
                                    errorMessage.textContent = 'Failed to resend confirmation email. Please try again later.';
                                }
                            });
                            
                            errorMessage.textContent = 'Please confirm your email address before signing in. ';
                            errorMessage.appendChild(resendLink);
                        } else {
                            // Generic error message as fallback
                            errorMessage.textContent = error.message || 'Failed to sign in';
                        }
                        
                        errorMessage.classList.remove('hidden');
                        
                        // Reset button
                        signinButton.disabled = false;
                        signinButton.textContent = 'Login';
                    }
                });
            }
            
            // Handle password toggle
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (togglePassword && passwordInput && eyeIcon) {
                togglePassword.addEventListener('click', () => {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        eyeIcon.src = '../../images/eye-slash.svg';
                    } else {
                        passwordInput.type = 'password';
                        eyeIcon.src = '../../images/eye.svg';
                    }
                });
            }
            
            // Handle signup link click with direct navigation
            const createAccountLink = document.getElementById('createAccountLink');
            if (createAccountLink) {
                createAccountLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('%c NAVIGATING TO SIGNUP PAGE', 'background: #8e44ad; color: white; font-size: 16px; padding: 4px 8px;');
                    // Use direct navigation for reliability
                    window.location.href = 'signup';
                });
            }
        })();
    </script>
<!-- End of Sign In Component -->
